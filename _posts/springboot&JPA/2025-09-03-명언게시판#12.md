---
title: "명언게시판 12단계 구현"
excerpt: "tdd적용"

categories:
  - java

date: 2025-09-03
last_modified_at: 2025-09-03
---

[깃허브 링크](https://github.com/gksdud1109/mission-3)

# 느낀점

- 강사님의 코드를 보며 AppConfig로 개발/테스트 모드 분리하는 것

  - 굳이 DB를 분리할 필요가 있나 생각했었는데
  - 스프링 구조 미리 알려주신거구나 이제 알았음

- Rq로 명령어 파싱해서 App클래스 -> controller로 넘겨주는 방식 깔끔한듯
- 아래는 깔끔해진 app클래스 코드, controller와의 역할분담이 좀더 명확한 것 같음

  ```java
  while (true) {
    System.out.print("명령) ");
    String nextCmd = sc.nextLine().trim();

    Rq rq = new Rq(nextCmd);
    String action = rq.getActionName();

    switch (action) {
        case "등록" -> wiseSayingController.register();
        case "목록" -> wiseSayingController.list();
        case "삭제" -> wiseSayingController.remove(rq);
        case "수정" -> wiseSayingController.update(rq);
        case "빌드" -> wiseSayingController.dataBuild();
        case "종료" -> {if(wiseSayingController.exit()) return;}
        default -> System.out.println("알 수 없는 명령입니다.");
    }
  }
  ```

- test코드 작성이 생각보다 어렵지 않구나를 알게 되었따. (구조가 실무보다는 복잡하지 않아서 그런가?)

- 아래도 작성하겠지만 Controller테스트를 위해 TestUtil클래스로 입출력 스트림을 바꿔 AppTestRunner로 구동하는 구조를 처음 접함

  - 이것 또한 Spring의 구조를 미리보여주시려고 가져왔구나 이제 다시보임

  - 입출력 스트림을 바꾸는 코드 자체를 처음 접해서 많이 배웠음

# 주요 변경점

## 테스트 구현 - repository

> 너무 길어서 깃허브 링크로 대체

[WiseSayingFileRepositoryTest.java](https://github.com/gksdud1109/mission-3/blob/main/src/test/java/com/back/repository/WiseSayingFileRepositoryTest.java)

## 테스트 구현 - controller

> 너무 길어서 깃허브 링크로 대체

[WiseSayingControllerTest.java](https://github.com/gksdud1109/mission-3/blob/main/src/test/java/com/back/controller/WiseSayingControllerTest.java)

## TestUtil과 AppTestRunner

- controller테스트를 하려면 강사님처럼 TestUtil에서 입출력 스트림 바꿔주는 기능이 필요해서 베낌
- 이런 식의 입출력 바꾸는 처리는 처음해봐서 많이 배웠음

```java
public class TestUtil {

    private static PrintStream ORIGINAL_OUT = System.out;
    private static PrintStream CURRENT_OUT = System.out;

    public static Scanner genScanner(String input) {
        return new Scanner(input);
    }

    public static ByteArrayOutputStream setOutToByteArray() {

        ORIGINAL_OUT = System.out;
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        PrintStream printStream = new PrintStream(outputStream);
        System.setOut(printStream);
        CURRENT_OUT = printStream;

        return outputStream;

    }

    public static void clearSetOutToByteArray(ByteArrayOutputStream outputStream) throws IOException {
        System.setOut(ORIGINAL_OUT);
        outputStream.close();
        CURRENT_OUT.close();
    }
}
```

```java
public class AppTestRunner {
    public static String run(String input) {

        Scanner sc = TestUtil.genScanner(input + "\n종료");
        ByteArrayOutputStream outputStream = TestUtil.setOutToByteArray();

        AppContext.init(sc);
        new wiseSayingApp().run();

        return outputStream.toString();
    }
}
```

## Rq 도입

- 강사님이 쓰신 Rq 좋아보여서 베낌
- 들어온 명령어 파싱해주는 용도로 쓰는 클래스임

-> 효과: app클래스가 깔끔해짐

```java
public class Rq {

    private String cmd;

    public Rq(String cmd){
        this.cmd = cmd;
    }

    public String getActionName(){
        return cmd.split("\\?")[0];
    }

    public String getParam(String inpuyKey, String defaultValue){
        Map<String, String> paramMap = new HashMap<>();

        String[] cmdBits = cmd.split("\\?");

        if(cmdBits.length < 2){
            return defaultValue;
        }

        String queryString = cmdBits[1];
        String[] queryBits = queryString.split("&");
        paramMap = Arrays.stream(queryBits)
                .map(param -> param.split("="))
                .filter(bits -> bits.length == 2 && bits[0] != null && bits[1] != null)
                .collect(
                        Collectors.toMap(
                                bits -> bits[0],
                                bits -> bits[1]
                        )
                );
        return paramMap.getOrDefault(inpuyKey, defaultValue);
    }

    public int getParamAsInt(String key, int defaultValue){
        String value = getParam(key, "");
        if(value.isBlank()){
            return defaultValue;
        }

        try {
            return Integer.parseInt(value);
        } catch (NumberFormatException e) {
            return defaultValue;
        }
    }
}
```

### 개선된 wiseSayingApp 클래스 (주석처리는 이전 구현)

```java
public class wiseSayingApp {

    private Scanner sc;
    private wiseSayingController wiseSayingController;

    public wiseSayingApp(){
        this.sc = AppContext.sc;
        this.wiseSayingController = AppContext.wiseSayingController;
    }

    public void run(){
        // 시작
        System.out.println("== 명언 앱 ==");

        while (true) {
            System.out.print("명령) ");
            String nextCmd = sc.nextLine().trim();

            Rq rq = new Rq(nextCmd);
            String action = rq.getActionName();

            switch (action) {
                case "등록" -> wiseSayingController.register();
                case "목록" -> wiseSayingController.list();
                case "삭제" -> wiseSayingController.remove(rq);
                case "수정" -> wiseSayingController.update(rq);
                case "빌드" -> wiseSayingController.dataBuild();
                case "종료" -> {if(wiseSayingController.exit()) return;}
                default -> System.out.println("알 수 없는 명령입니다.");
            }


//            // 종료
//            if (nextCmd.equals("종료"))
//                break;
//            // 등록
//            else if (nextCmd.equals("등록"))
//                wiseSayingController.register();
//            // 목록
//            else if (nextCmd.equals("목록"))
//                wiseSayingController.list();
//            // 삭제
//            else if (nextCmd.startsWith("삭제?id=")) {
//                int id = Integer.parseInt(nextCmd.substring("삭제?id=".length()));
//                wiseSayingController.remove(id);
//            }
//            // 수정
//            else if (nextCmd.startsWith("수정?id=")) {
//                int id = Integer.parseInt(nextCmd.substring("수정?id=".length()));
//                wiseSayingController.update(id);
//            }
//            else if (nextCmd.equals("빌드")){
//                boolean result = wiseSayingController.dataBuild();
//                if(result) System.out.println("data.json 파일의 내용이 갱신되었습니다.");
//                else System.out.println("data.json 파일 갱신 실패ㅠㅠ");
//            }
//            else System.out.println("알 수 없는 명령입니다.");
        }
    }
}
```

## AppConfig 도입으로 테스트용DB, 개발용DB 저장 경로 분리

```java
public final class AppConfig {

    private static final String KEY = "app.mode";

    public static String getMode() {
        return System.getProperty(KEY, "dev"); // 기본 dev
    }

    public static void setMode(String mode) {
        System.setProperty(KEY, mode);
    }

    public static void setTestMode() { setMode("test"); }

    public static void setDevMode()  { setMode("dev"); }
}
```

### jsonUtil 클래스에서 AppConfig의 모드를 가져오면 folder 저장 경로를 다르게 설정합니다

```java
public class jsonUtil {
    private final String FOLDER ;

    public jsonUtil(){
        String mode = AppConfig.getMode();
        this.FOLDER = mode + "/db/wiseSaying/";
    }

    public String getFolder(){
        return this.FOLDER;
    }

...
}
```

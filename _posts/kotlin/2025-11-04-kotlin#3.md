---
title: "[Kotlin#3] ì½”í‹€ë¦° ê¶ê¸ˆí•œ ì  & ê¸°ì´ˆë¬¸ë²• ì •ë¦¬"
date: 2025-11-04 09:00:00 +0900
categories: [Kotlin]
tags: [programming, kotlin]
---
## ìë°”ì—ì„œ ë°”ê¾¼ ì½”í‹€ë¦° ì½”ë“œ

```kotlin
@Component
class CustomOAuth2AuthorizationRequestResolver(
    private val clientRegistrationRepository: ClientRegistrationRepository
) : OAuth2AuthorizationRequestResolver {

    private val defaultResolver = DefaultOAuth2AuthorizationRequestResolver(
        clientRegistrationRepository,
        OAuth2AuthorizationRequestRedirectFilter.DEFAULT_AUTHORIZATION_REQUEST_BASE_URI
    )

    override fun resolve(request: HttpServletRequest): OAuth2AuthorizationRequest? =
        defaultResolver.resolve(request)?.let{customizeState(it, request)}

    override fun resolve(request: HttpServletRequest, clientRegistrationId: String?): OAuth2AuthorizationRequest? =
        defaultResolver.resolve(request, clientRegistrationId)?.let{customizeState(it, request)}

    private fun customizeState(
        authorizationRequest: OAuth2AuthorizationRequest,
        req: HttpServletRequest
    ): OAuth2AuthorizationRequest {
        val redirectUrl = req.getParameter("redirectUrl") ?: "/"
        val originState = authorizationRequest.state
        val newState = "$originState#$redirectUrl"
        val encodedState = Base64.getUrlEncoder().encodeToString(newState.toByteArray(StandardCharsets.UTF_8))

        return OAuth2AuthorizationRequest.from(authorizationRequest)
            .state(encodedState)
            .build()
    }
}
```

# ì—¬ê¸°ì„œ OAuth2AuthorizationRequest ì´ê²Œ ì™œ ë¶ˆë³€ê°ì²´ì•¼?

## â€œë¶ˆë³€ ê°ì²´â€

> ë¶ˆë³€ ê°ì²´(Immutable Object) : í•œ ë²ˆ ìƒì„±ë˜ë©´ ë‚´ë¶€ ìƒíƒœ(í•„ë“œ ê°’)ê°€ ì ˆëŒ€ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ê°ì²´

ì¦‰, setterê°€ ì—†ê³ , í•„ë“œê°€ finalì´ë©°, ê°ì²´ì˜ ë©”ì„œë“œê°€ ë‚´ë¶€ ê°’ì„ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ.
ğŸ‘‰ ìƒˆë¡œìš´ ê°’ì„ ê°€ì§€ë ¤ë©´ ìƒˆ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì•¼ í•¨.

ì˜ˆì‹œ: 
```kotlin
data class User(val name: String, val age: Int)

// ê¸°ì¡´ ê°ì²´ ë³€ê²½ì´ ì•„ë‹ˆë¼ ë³µì œ(copy)
val user2 = user.copy(age = 30)
```

UserëŠ” ë¶ˆë³€ ê°ì²´ë‹¤.
user.age = 30ì²˜ëŸ¼ ë°”ê¾¸ëŠ” ê±´ ë¶ˆê°€ëŠ¥.

# OAuth2AuthorizationRequest ë‚´ë¶€ë¥¼ ë³´ë©´

```kotlin
public final class OAuth2AuthorizationRequest implements Serializable {
    private final String authorizationUri;
    private final String clientId;
    private final String redirectUri;
    private final Set<String> scopes;
    private final String state;
    private final Map<String, Object> additionalParameters;
    ...
}
```

í•µì‹¬ í‚¤ì›Œë“œ ğŸ‘‡
-	public final class â†’ ìƒì† ë¶ˆê°€
-	ëª¨ë“  í•„ë“œê°€ private final
-	setter ì—†ìŒ
-	ìƒì„±ìëŠ” private
-	ê°’ ë³€ê²½ì€ .from(existing).state(newValue).build() ë¡œë§Œ ê°€ëŠ¥

ì¦‰, Spring Securityê°€ ëª…ì‹œì ìœ¼ë¡œ ë¶ˆë³€ ê°ì²´ë¡œ ì„¤ê³„í•œ ê²ƒì„.

## ì™œ ì´ë ‡ê²Œ ì„¤ê³„í–ˆì„ê¹Œ?

OAuth2 í”„ë¡œí† ì½œì€ ë³´ì•ˆì´ í•µì‹¬
íŠ¹íˆ OAuth2AuthorizationRequestëŠ” ì‚¬ìš©ìì˜ ì¸ê°€ ìš”ì²­ ì •ë³´ë¥¼ ë‹´ê³  ìˆì–´ì„œ ì¤‘ê°„ì— ê°’ì´ ë³€í•˜ë©´ ë³´ì•ˆìƒ ë¬¸ì œê°€ ìƒê¹€

ì˜ˆë¥¼ ë“¤ì–´ redirectUri, clientId, state ë“±ì´ ë³€ì¡°ë˜ë©´
â†’ OAuth ì¸ì¦ íë¦„ì´ ê¹¨ì§€ê³ , í”¼ì‹± ê³µê²©ì´ ê°€ëŠ¥í•´ì ¸.

ê·¸ë˜ì„œ ì´ ê°ì²´ëŠ”
- ìƒì„± ì‹œì ì—ë§Œ ê°’ì´ ì •í•´ì§€ê³ ,
- ì´í›„ ì ˆëŒ€ ë°”ê¿€ ìˆ˜ ì—†ë„ë¡ final + private constructorë¡œ ë§‰ì•„ë‘” ê±°ì•¼.

# ê·¸ëŸ¼ .from(...).state(...).build()ëŠ” ë­ì•¼?

ì´ê±´ ë³µì‚¬ ê¸°ë°˜ ë¹Œë” íŒ¨í„´(copy builder)
ì¦‰, ê¸°ì¡´ ë¶ˆë³€ ê°ì²´ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒˆë¡œìš´ ë¶ˆë³€ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•.

```kotlin
val newRequest = OAuth2AuthorizationRequest.from(oldRequest)
    .state("encodedState")
    .build()
```

ìë°” ì½”ë“œë¥¼ ë³´ë©´ from() ë©”ì„œë“œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì´ë ‡ê²Œ ìƒê¹€ğŸ‘‡
```java
public static Builder from(OAuth2AuthorizationRequest authorizationRequest) {
    Assert.notNull(authorizationRequest, "authorizationRequest cannot be null");
    Builder builder = new Builder(authorizationRequest.getAuthorizationUri());
    builder.clientId(authorizationRequest.getClientId());
    ...
    builder.state(authorizationRequest.getState());
    return builder;
}
```

# ì „ì²´ íë¦„ ì •ë¦¬ (OAuth2)

> â€œSpring Securityì˜ ê¸°ë³¸ OAuth ìš”ì²­ ìƒì„±ê¸°(DefaultOAuth2AuthorizationRequestResolver)ë¥¼ ê°ì‹¸ì„œ,
ì»¤ìŠ¤í…€ stateë¥¼ ì¶”ê°€í•œ ìƒˆ ìš”ì²­(OAuth2AuthorizationRequest ë¶ˆë³€ê°ì²´)ì„ ë°˜í™˜í•˜ëŠ” êµ¬ì¡°.â€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CustomOAuth2AuthorizationRequestResolver â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  DefaultOAuth2AuthorizationRequestResolver â”‚ â† (Spring ê¸°ë³¸ êµ¬í˜„)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
     resolve(request, clientId)  â†  ê¸°ë³¸ ì¸ê°€ ìš”ì²­ ìƒì„±
                 â”‚
                 â–¼
     customizeState(ìš”ì²­, HttpServletRequest)
         â””â”€> redirectUrl, state ê°’ ì»¤ìŠ¤í…€
                 â”‚
                 â–¼
     ìƒˆë¡œ build()ëœ OAuth2AuthorizationRequest ë°˜í™˜
```

âœ”ï¸ defaultResolverëŠ” ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ê¸°ë³¸ ì¸ê°€ ìš”ì²­ ìƒì„±ê¸°
âœ”ï¸ ìš°ë¦¬ëŠ” ê·¸ ê²°ê³¼(OAuth2AuthorizationRequest)ë¥¼ ë°›ì•„ì„œ stateë¥¼ ì¶”ê°€ë¡œ ì¸ì½”ë”©í•œ ë’¤ ë°˜í™˜í•˜ëŠ” ê²ƒ

# defaultResolverì˜ ì—­í• 

```kotlin

private val defaultResolver = DefaultOAuth2AuthorizationRequestResolver(
    clientRegistrationRepository,
    OAuth2AuthorizationRequestRedirectFilter.DEFAULT_AUTHORIZATION_REQUEST_BASE_URI
)
```

-	clientRegistrationRepository:
ìŠ¤í”„ë§ì´ ê´€ë¦¬í•˜ëŠ” OAuth2 í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ì €ì¥ì†Œ
(ì˜ˆ: application.ymlì— ìˆëŠ” spring.security.oauth2.client.registration.kakao, google ë“±)
-	DEFAULT_AUTHORIZATION_REQUEST_BASE_URI:
/oauth2/authorization ì´ ê¸°ë³¸ URI </br>
â†’ ì˜ˆë¥¼ ë“¤ì–´ /oauth2/authorization/kakaoë¡œ ì ‘ì†í•˜ë©´ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ë„ë¡ ì„¤ì •ë¨.

ì¦‰, defaultResolverëŠ”
â€œìš”ì²­ì„ ë³´ê³ , ì–´ë–¤ í´ë¼ì´ì–¸íŠ¸(kakao/google/naver)ì¸ì§€ íŒë‹¨í•´ì„œ
ê·¸ì— ë§ëŠ” OAuth2AuthorizationRequestë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ê¸°ë³¸ ë¡œì§â€ì„ ë‹´ë‹¹í•¨

## ë‘ ê°œì˜ resolve() í•¨ìˆ˜ì˜ ì°¨ì´

ì—¬ê¸°ì„œ í•µì‹¬ì€ â€œì˜¤ë²„ë¡œë”©ëœ ë©”ì„œë“œ (Overloaded Method)â€
Spring Securityì˜ OAuth2AuthorizationRequestResolver ì¸í„°í˜ì´ìŠ¤ê°€ ë‘ ê°€ì§€ ì‹œê·¸ë‹ˆì²˜ë¥¼ ìš”êµ¬í•˜ê¸° ë•Œë¬¸ì„ ğŸ‘‡

```java
OAuth2AuthorizationRequest resolve(HttpServletRequest request);

OAuth2AuthorizationRequest resolve(HttpServletRequest request, String clientRegistrationId);
```

âœ… (1) resolve(request: HttpServletRequest)
-	ì‚¬ìš©ìê°€ URLë¡œ ì ‘ê·¼í•  ë•Œ,
ì˜ˆë¥¼ ë“¤ì–´ /oauth2/authorization/kakao ì´ëŸ° ê¸°ë³¸ URIë¡œ ì ‘ê·¼í•˜ë©´
ë‚´ë¶€ì ìœ¼ë¡œ clientRegistrationId (kakao)ë¥¼ URIì—ì„œ ì¶”ì¶œí•´ì„œ ìë™ìœ¼ë¡œ ë„˜ê²¨ì¤Œ.

ì¦‰, ì´ ë²„ì „ì€ â€œURIì—ì„œ clientIdë¥¼ ì•Œì•„ë‚´ëŠ” ì¼ë°˜ ì¼€ì´ìŠ¤â€ì•¼.
(ëŒ€ë¶€ë¶„ ì´ê²Œ í˜¸ì¶œëŒ)

â¸»

âœ… (2) resolve(request: HttpServletRequest, clientRegistrationId: String?)
-	OAuth í´ë¼ì´ì–¸íŠ¸ë¥¼ í”„ë¡œê·¸ë˜ë°ì ìœ¼ë¡œ ì§ì ‘ ì§€ì •í•  ë•Œ í˜¸ì¶œë¨.

ì˜ˆì‹œ:
ë¡œê·¸ì¸ í˜ì´ì§€ì— ë²„íŠ¼ì´ ì—¬ëŸ¬ ê°œ ìˆì–´ì„œ, JSì—ì„œ
â€œì¹´ì¹´ì˜¤ ë¡œê·¸ì¸â€ ë²„íŠ¼ í´ë¦­ â†’ /custom/oauth2/kakao ìš”ì²­ì„ ë³´ë‚¼ ë•Œ
ì§ì ‘ clientRegistrationId = "kakao"ë¥¼ ëª…ì‹œí•  ìˆ˜ë„ ìˆì§€.

Spring Security ë‚´ë¶€ì ìœ¼ë¡œë„ OAuth2AuthorizationRequestRedirectFilterê°€
í´ë¼ì´ì–¸íŠ¸ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì°¾ì„ ë•Œ ì´ ì˜¤ë²„ë¡œë“œë¥¼ ì‚¬ìš©í•´.

ì¦‰,

ì²« ë²ˆì§¸ resolve()ëŠ” URI ê¸°ë°˜ ìë™ ì¶”ë¡ 
ë‘ ë²ˆì§¸ resolve()ëŠ” ëª…ì‹œì  clientRegistrationId ê¸°ë°˜

